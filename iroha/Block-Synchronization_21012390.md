1. [Hyperledger Iroha](index.html)
2. [Hyperledger Iroha](Hyperledger-Iroha_20873224.html)
3. [Iroha 2](Iroha-2_21012047.html)
4. [Architecture Decision Records Log](Architecture-Decision-Records-Log_21016003.html)

# Hyperledger Iroha : Block Synchronization

Created by Egor Ivkov, last modified on Aug 05, 2020

Status

COMMENTED

Stakeholders

[Egor Ivkov](https://lf-hyperledger.atlassian.net/wiki/people/5dd9631c1cf3c20ef5ff9f0f?ref=confluence) [武宮誠](https://lf-hyperledger.atlassian.net/wiki/people/557058:12c320e6-5d17-404f-b20e-bfa5721ae960?ref=confluence) [Kamil Salakhiev](https://lf-hyperledger.atlassian.net/wiki/people/557058:07723e0b-a027-4cc4-ad6d-324e41cccb4d?ref=confluence)

Outcome

Error rendering macro 'jira' : null

Error rendering macro 'jira' : null

Due date

07 Aug 2020

Owner

[Egor Ivkov](https://lf-hyperledger.atlassian.net/wiki/people/5dd9631c1cf3c20ef5ff9f0f?ref=confluence)

## Background

Block synchronization is briefly discussed in whitepaper, nevertheless much more details are needed for this feature. Also several design decisions were taken during the implementation that influence other core modules. Therefore this document is meant to review in detail the current design of block synchronization and start a discussion of what changes are accepted by the core team and what needs to be corrected in the future.

## Problem

### Scenarios

The following are the scenarios for the block synchronization:

1. New peer joins the validator network and needs to get the whole blockchain.
2. The peer lost several commit messages due to poor internet connection and needs to get the latest blocks.
3. The peer was stopped and restarted after some time and needs to get the latest blocks.
4. ...

## Solution

### Gossip

For peers to discover that they do not have latest blocks, peers send their latest block hashes to all other peers in the network every **N** seconds. If a peer discovers that it has a different latest block hash, it will request the missing blocks from other peers.

#### Sequence Diagram

![](attachments/21012390/21016486.png)

The sequence diagram here represents a scenario where new peer has joined the peer network. The peers latest block hash will be \`\[0u8, 32]\`, while other peers would have different latest block hash, assuming they committed several other blocks. Therefore the new peer will request missing blocks.

#### Activity Diagram

![](attachments/21012390/21016485.png)

Activity diagram represents a synchronization process from the moment of receiving the latest block hash to the moment when all the new blocks are stored.

#### Block Validation

To validate the signatures of the block the peer needs to have:

1. The set of peers that were validators at the moment of discussing that block in consensus
2. The order of those peers that defines their roles at the moment of discussion

#### Set of peers

The set of peers will already be up to date for this block validation on our peer as the initial peers set is taken from the \`trusted\_peers\` file and new peers are added through AddPeer ISI, therefore only on block commits.

#### Order of peers

The order and therefore roles are defined based on the previously committed block hash. But the order is shifted every time a view change happens (when leader or proxy tail is faulty or the voting fails).

The synchronizing peer will definitely have a previous block hash, but it does not know the number of view changes (order shifts) that happened between the previous block and the new block were committed.

Therefore a new field was added to the block header: number\_of\_view\_changes. It specifies the number of view changes that happened between the commit of the previous block and the commit of the block in which header it exists.

With this design both the set of validating peers and their roles are known to the synchronizing peer for each new block.

### Decisions

### Alternatives

### Concerns

### Assumptions

### Risks

## Additional Information

## Attachments:

![](images/icons/bullet_blue.gif) [activity.png](attachments/21012390/21016485.png) (image/png)  
![](images/icons/bullet_blue.gif) [sequence.png](attachments/21012390/21016486.png) (image/png)

Document generated by Confluence on Nov 26, 2024 15:05

[Atlassian](http://www.atlassian.com/)
