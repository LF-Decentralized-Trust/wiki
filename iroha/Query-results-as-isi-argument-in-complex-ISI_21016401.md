1. [Hyperledger Iroha](index.html)
2. [Hyperledger Iroha](Hyperledger-Iroha_20873224.html)
3. [Iroha 2](Iroha-2_21012047.html)
4. [Architecture Decision Records Log](Architecture-Decision-Records-Log_21016003.html)
5. [DEX Generic Scenarios](DEX-Generic-Scenarios_21012490.html)

# Hyperledger Iroha : Query results as isi argument in complex ISI

Created by Yuriy Vinogradov, last modified by Nikita Puzankov on Aug 05, 2020

Status

IN PROGRESS

Stakeholders

[Yuriy Vinogradov](https://lf-hyperledger.atlassian.net/wiki/people/557058:0b85dbf9-2cc9-4bee-a3a0-2815e5bb51eb?ref=confluence)  [Egor Ivkov](https://lf-hyperledger.atlassian.net/wiki/people/5dd9631c1cf3c20ef5ff9f0f?ref=confluence) [Vladislav Markushin](https://lf-hyperledger.atlassian.net/wiki/people/5ecbc0c8eb77320c1f684409?ref=confluence) 

Outcome  
Due date

07 Aug 2020

Owner

[Nikita Puzankov](https://lf-hyperledger.atlassian.net/wiki/people/5df113768998970e5b434e0a?ref=confluence) 

## Background

In some cases, we need to propagate the Iroha Special Instruction's result as an argument to the next Iroha Special Instruction building a pipeline from several instructions. 

### Example

In DEX we need to check the conversion amount in the pool for a token to be exchanged. Then we need to send this value to the ISI which will send exchanged funds to the user. Last ISI should send exactly the same amount as defined by the conversion rate query. So query should somehow set this information as an argument to the next ISI.

## Problem

Transaction's processing in Iroha 2.0 is a sequential execution of Iroha Special Instructions on World State View. Current signature looks like this: WorldStateView --execute(ISI\_arguments..)→ WorldStateView.

All Iroha Special Instruction's arguments are provided by the incoming transaction and distributed across the ledger as is. The only way to work with current design to cover needs from the Abstract is to set calculation's results on the World State View in form of assets.

## Solution

We send a composite Iroha Special Instruction to execute the following algorithm:

1. Execute Iroha Query to find "conversion amount in the pool" and Add Parameter Asset with this amount to the Account.
2. Execute Iroha Query to get this amount and send exchanged funds.
3. Execute Iroha Query to get this amount and send them.
4. Remove Parameter Asset with this amount from the account.

Because this is one Iroha Special Instruction we will prevent harm from "side" effects of other transactions and instructions. We will also have the same state across all peers with full history of values used for exchange.

### Decisions

Current Iroha Special Instructions model can cover these cases by storing all calculations on the blockchain as assets.

### Alternatives

- An ability to pass arguments from one instruction inside transaction to another - can cause side effects and will bring up additional complexity
- An additional temporary storage for transactions with direct access from instructions - additional public API to maintain and possible differences across the ledger

### Concerns

- Some users may not agree with concept of Iroha Special Instruction composition and would prefer more imperative style

### Assumptions

- Composite Iroha Special Instructions (If, Sequence, Pair) in combination with \`Query\` instruction will cover DEX cases.

### Risks

- Some cases are not listed and wouldn't be covered \`\[2;7]\`
- Additional out-of-the-box instructions would needed \`\[2;4]\`

Document generated by Confluence on Nov 26, 2024 15:06

[Atlassian](http://www.atlassian.com/)
