1. [Hyperledger Iroha](index.html)
2. [Hyperledger Iroha](Hyperledger-Iroha_20873224.html)
3. [Iroha 1](Iroha-1_21015959.html)
4. [Instructions](Instructions_21015946.html)

# Hyperledger Iroha : How to build Iroha 1.0 under MSAN

Created by Konstantin Munichev, last modified on May 21, 2019

### Requirements

Linux (msan doesn’t work on Windows or MacOS), clang 8 (7 should also work)

### Build instrumented version of libc++

- Checkout LLVM, libc++ and libc++abi

*$ svn co [http://llvm.org/svn/llvm-project/llvm/trunk](http://llvm.org/svn/llvm-project/llvm/trunk) llvm*

*$ (cd llvm/projects &amp;&amp; svn co [http://llvm.org/svn/llvm-project/libcxx/trunk](http://llvm.org/svn/llvm-project/libcxx/trunk) libcxx)*

*$ (cd llvm/projects &amp;&amp; svn co [http://llvm.org/svn/llvm-project/libcxxabi/trunk](http://llvm.org/svn/llvm-project/libcxxabi/trunk) libcxxabi)*

- Build libc++ with MSan:

*$ mkdir libcxx\_msan &amp;&amp; cd libcxx\_msan*

*$ cmake ../llvm -DCMAKE\_BUILD\_TYPE=Release -DLLVM\_USE\_SANITIZER=Memory -DCMAKE\_C\_COMPILER=clang-8 -DCMAKE\_CXX\_COMPILER=clang++-8*

*$ make cxx -j$(nproc)*

### Build instrumented version of boost

- Download  and unpack boost from [https://dl.bintray.com/boostorg/release/1.70.0/source/boost\_1\_70\_0.tar.bz2](https://dl.bintray.com/boostorg/release/1.70.0/source/boost_1_70_0.tar.bz2)
- Download [https://raw.githubusercontent.com/ecatmur/variant/7331d648f46b6008138cbd22087b8c5c61ff7926/include/boost/variant/detail/apply\_visitor\_unary.hpp](https://raw.githubusercontent.com/ecatmur/variant/7331d648f46b6008138cbd22087b8c5c61ff7926/include/boost/variant/detail/apply_visitor_unary.hpp) and replace ./boost/variant/detail/apply\_visitor\_unary.hpp with it
- Download [https://raw.githubusercontent.com/ecatmur/variant/7331d648f46b6008138cbd22087b8c5c61ff7926/test/const\_ref\_apply\_visitor.cpp](https://raw.githubusercontent.com/ecatmur/variant/7331d648f46b6008138cbd22087b8c5c61ff7926/test/const_ref_apply_visitor.cpp) and replace ./libs/variant/test/const\_ref\_apply\_visitor.cpp with it
- From the directory where you have just unpacked boost run:

*$ ./bootstrap.sh --with-libraries=thread,system,filesystem --prefix=/home/luckychess/src/msan\_guide/boost/boost\_1\_70\_0\_msan --with-toolset=clang*

(--prefix is a path where built libraries will be stored, create this directory first)

- Open file project-config.jam with a text editor. Find “using clang” line and replace it with the next line:

*using clang : 8.0 : : &lt;cxxflags&gt;"-fsanitize=memory -fsanitize-memory-track-origins -stdlib=libc++ -L/home/luckychess/src/msan\_guide/libcxx\_msan/lib -lc++abi -I/home/luckychess/src/msan\_guide/libcxx\_msan/include -I/home/luckychess/src/msan\_guide/libcxx\_msan/include/c++/v1" ;*

Paths at -L and -I parameters are actually paths to directories from the previous step. Also please note - there is a space after ; (in the line’s very end)

### Prepare Iroha to build (check [https://github.com/luckychess/iroha-1/tree/msan](https://github.com/luckychess/iroha-1/tree/msan)):

- Please ensure that no external dependencies are installed (like protobuf, grpc…). Boost can be installed - boost path will be passed to cmake explicitly.
- In the root CMakeLists.txt find

*append\_build\_flags(-fsanitize=memory -fsanitize-memory-track-origins)*

line and replace it with

*append\_build\_flags(-fsanitize=memory -fsanitize-memory-track-origins -stdlib=libc++ -L/home/luckychess/src/msan\_guide/libcxx\_msan/lib -lc++abi -I/home/luckychess/src/msan\_guide/libcxx\_msan/include -I/home/luckychess/src/msan\_guide/libcxx\_msan/include/c++/v1 -Wno-error=unused-command-line-argument)*

(change paths to your own)

- In *functions.cmake* add libcxx\_msan/lib path to LD\_LIBRARY\_PATH for protoc, e.g.:

*set(GEN\_COMMAND ${CMAKE\_COMMAND} -E env LD\_LIBRARY\_PATH=${protobuf\_LIBRARY\_DIR}:$ENV{LD\_LIBRARY\_PATH}:/home/luckychess/src/libcxx\_msan/lib "${protoc\_EXECUTABLE}")*

Note: tbb still remains uncovered which could bring some inaccuracies. It's way too painful to integrate it at the moment.

### Build Iroha

*$ mkdir build &amp;&amp; cd build*

*$ cmake -DCMAKE\_C\_COMPILER=clang-8 -DCMAKE\_CXX\_COMPILER=clang++-8 -DSANITIZE\_MEMORY=ON -DBOOST\_ROOT=/home/luckychess/src/msan\_guide/boost/boost\_1\_70\_0\_msan ..*

(set -DBOOST\_ROOT to your own boost root )

*$ LD\_LIBRARY\_PATH=/home/luckychess/src/msan\_guide/libcxx\_msan/lib make irohad (*or just *make)* (again use your own path)

Document generated by Confluence on Nov 26, 2024 15:05

[Atlassian](http://www.atlassian.com/)
